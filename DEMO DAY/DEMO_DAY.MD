# Caso Real: O desastre da atualiza√ß√£o n√£o testada no time de Backend

## Personagens:
- **Carlos** (Tech Lead do Backend): Queria atualizar o servidor de pagamentos para Node.js 18.
- **Ana** (Dev Backend Jr): Fez a atualiza√ß√£o direto no servidor de produ√ß√£o sem avisar.
- **Time de Infra** (Kalu e equipe): Descobriu o problema s√≥ quando o app quebrou.

## O Que Aconteceu?
Ana acessou o servidor de produ√ß√£o via SSH e rodou:

```bash
sudo apt-get install -y nodejs=18.0.0  # Atualizou manualmente
```

### O Resultado:
- O app parou de funcionar porque dependia de uma lib incompat√≠vel com Node 18.
- Ningu√©m sabia o que havia mudado (n√£o havia registro da altera√ß√£o).
- O time ficou 4 horas tentando descobrir o problema.

## Solu√ß√£o com Terraform + Git (Passo a Passo Humanizado)

### 1. Carlos (Tech Lead) Define a Infra como C√≥digo
Criou um arquivo chamado `servers.tf`:

```hcl
resource "aws_instance" "servidor_pagamentos" {
  ami           = "ami-0c55b159cbfafe1f0"  # Ubuntu 22.04
  instance_type = "t2.medium"
  user_data     = file("setup_node.sh")    # Script que instala Node.js 16

  tags = {
    Time      = "Backend"
    Responsavel = "Carlos"
  }
}
```

### 2. O Script Controlado (setup_node.sh)
```bash
#!/bin/bash
# Instala a vers√£o CORRETA do Node.js
curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### 3. Ana quer atualizar? Agora √© seguro!
- Ela edita o `setup_node.sh` para Node 18 e abre um Pull Request no GitHub.
- Isa e Kalu (Infra) revisam e testam em homologa√ß√£o.
- Se tudo ok, o merge no main dispara um terraform apply autom√°tico.

## Por que isso evita o caos?
- **Rastreabilidade**: Sabemos quem pediu a mudan√ßa (Ana) e quando (hist√≥rico do Git).
- **Testes**: A atualiza√ß√£o √© testada antes de ir para produ√ß√£o.
- **Padroniza√ß√£o**: Todos os servidores usam a mesma vers√£o do Node.js.

## üîß Etapas para resolver o config drift

### 1Ô∏è‚É£ Etapa 1: Identificar o problema
**Objetivo**: Entender onde est√° a inconsist√™ncia.

**Como fazer**:
Acesse servidores manualmente via SSH e compare:

```bash
# Verifique vers√µes de pacotes:
python3 --version
nginx -v
# Verifique configura√ß√µes cr√≠ticas:
sudo cat /etc/nginx/nginx.conf
```

**Sa√≠da esperada**:
- Diferen√ßas entre servidores (ex: Python 3.8 vs 3.10).

### 2Ô∏è‚É£ Etapa 2: Definir infraestrutura como c√≥digo (Terraform)
**Objetivo**: Criar um template replic√°vel.

**Arquivo**: `servers.tf`

```hcl
provider "aws" {
  region = "us-east-1"
}

resource "aws_instance" "web_server" {
  ami           = "ami-0c55b159cbfafe1f0"  # Ubuntu 22.04
  instance_type = "t2.micro"
  user_data     = file("init_script.sh")   # Script de inicializa√ß√£o

  tags = {
    Name = "web-server-padrao"
  }
}
```

**Conte√∫do de `init_script.sh`**:
```bash
#!/bin/bash
apt-get update
apt-get install -y nginx python3
systemctl start nginx
```

### 3Ô∏è‚É£ Etapa 3: Versionar no Git
**Objetivo**: Rastrear mudan√ßas e permitir colabora√ß√£o.

**Comandos**:
```bash
git init
git add servers.tf init_script.sh
git commit -m "Primeira vers√£o da infraestrutura"
git remote add origin https://github.com/seu-user/repo.git
git push -u origin main
```

### 4Ô∏è‚É£ Etapa 4: Aplicar o Terraform
**Objetivo**: Criar servidores padronizados.

**Comandos**:
```bash
terraform init   # Inicializa o projeto
terraform plan   # Mostra o que ser√° criado
terraform apply  # Executa a cria√ß√£o (digite "yes")
```

**Sa√≠da esperada**:
- Servidor AWS EC2 criado com Nginx e Python pr√©-instalados.

### 5Ô∏è‚É£ Etapa 5: Eliminar o Config Drift
**Objetivo**: Garantir que servidores existentes sigam o padr√£o.

**Como fazer**:
Para servidores j√° existentes:

Importe recursos manuais para o Terraform:
```bash
terraform import aws_instance.web_server i-0123456789abcdef0
```

Aplique o c√≥digo para sincronizar:
```bash
terraform apply
```

### 6Ô∏è‚É£ Etapa 6: Monitorar e Manter
**Objetivo**: Evitar novas inconsist√™ncias.

**Ferramentas**:
- GitHub Actions: Pipeline para validar mudan√ßas no Terraform.
- AWS Config: Monitora desvios na infraestrutura.
